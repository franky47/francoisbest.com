export const metadata = {
  title: 'Displaying the right deployment URLs on Vercel',
  description:
    'A TIL about build caching, Git branch management and React Server Components',
  tags: ['til', 'rsc', 'git'],
  publicationDate: '2023-09-09',
}

## The issue

At the bottom of this page, I have a "Discuss on Hacker News" link. It points
to the Hacker News search engine with the URL of the current page.

I was having issues on Vercel when deploying first on a preview branch, then
merging my `main` production branch onto it: production links would show the preview URL.

## Linear Git branching

My branching strategy for this website doesn't use Pull Requests, but rather
sees Git branches as labels that can move up the commit tree, using fast-forward merges:

<figure>
  ![Ungit showing a git tree with several commits in line. The "this-is-a-label"
  branch can be moved from an old commit to the HEAD with ungit.](./ungit.png)
  <figcaption className="text-center">
    I use [Ungit](https://github.com/FredrikNoren/ungit) to display and navigate
    Git histories
  </figcaption>
</figure>

To help with performance, Vercel only considers the Git SHA to trigger a new build.
Any branch pushed to the same SHA will reuse the build cache to speed up deployments.

The problem is that this will cause the preview URLs to show up on the production deployment.
I use React Server Components to render those URLs, that render to HTML only once.

A solution would be to render this link as a client component,
and tie it to the `NEXT_PUBLIC_VERCEL_URL` -- which is correct at runtime --
instead of burning in the build-only `VERCEL_URL` in a server component.

However, the correct URL is also needed in a couple of places where this solution won't work:

- [robots.txt](/robots.txt)
- [sitemap.xml](/sitemap.xml)
- [RSS feed URLs](/posts/feed/rss.xml)
- [Metadata](https://nextjs.org/docs/app/building-your-application/optimizing/metadata) base URLs

## Solution

Set the `VERCEL_FORCE_NO_BUILD_CACHE` environment variable to 1 for production deployments.

## Other attempts

I first tried to tell Vercel to rebuild for each push by setting the "Ignored Build Step"
behavior to "Custom" with a value of `exit 1`, but it did not work:

<figure>
  ![When a commit is pushed to the Git repository that is connected with your
  Project, its SHA will determine if a new Build has to be issued. If the SHA
  was deployed before, no new Build will be issued. You can customize this
  behavior with a command that exits with code 1 (new Build needed) or code
  0.](./vercel.png)
  <figcaption className="text-center">
    You can find this setting in your project > Settings > Git
  </figcaption>
</figure>

<Note>

If you are used to non-zero Unix exit codes indicating a problem, this may seem
weird.

However, it's a double negative situation here: saying "no" to an "Ignore build" to actually trigger the build.
It's a bit confusing.

</Note>
